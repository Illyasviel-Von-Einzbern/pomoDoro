import{o as B}from"./index-Dob3nYDb.js";import{a2 as j,a3 as L,r as g,a4 as A,Q as D,R as d,S as N,T as f,c as r,U as $,W as w,a,Y as y,F as K,$ as O,_ as b,a0 as v,Z as V,a1 as T,a5 as I}from"./index-88BeCIkd.js";import{d as Y}from"./forwardRefs-mZDv5K0_.js";import{V as E,a as G}from"./VRadioGroup-oBy_e5EN.js";const M=""+new URL("922794cdce1bc62d208771cf1ebbd1cc-Dv1XYcdF.gif",import.meta.url).href,Q=["src"],W=["onClick"],X={class:"upload-btn"},Z={key:0,style:{color:"red"}},q={__name:"SettingsView",setup(z){const o=L(),p=g(""),c=g(null),h=async()=>{c.value=await B("AlarmDB",1,{upgrade(t){t.objectStoreNames.contains("media")||t.createObjectStore("media")}})},k=async()=>{const e=c.value.transaction("media","readonly").objectStore("media"),l=await e.getAllKeys(),n=[];for(const i of l){const s=await e.get(i),u=URL.createObjectURL(s);n.push({id:s.name,name:s.name,file:u})}const _=new Set(o.alarms.map(i=>i.id));for(const i of n)_.has(i.id)||o.alarms.push(i)},x=async t=>{const l=Array.from(t.target.files).filter(s=>s.type==="audio/mpeg"||s.type==="video/mp4");if(l.length===0){p.value="只能上傳 mp3 或 mp4 檔案。";return}const n=c.value.transaction("media","readwrite"),_=n.objectStore("media"),i=await _.getAllKeys();for(let s of l){let u=s.name;if(i.includes(u)){const C=Date.now(),U=s.name.split(".").pop();u=`${s.name.replace(/\.[^/.]+$/,"")}_${C}.${U}`}const m=new File([s],u,{type:s.type});await _.put(m,m.name);const R=URL.createObjectURL(m);o.alarms.push({id:m.name,name:m.name,default:!1,file:R})}await n.done},S=t=>!t.default,F=async t=>{if(!(!c.value||!(t!=null&&t.id)))try{const e=c.value.transaction("media","readwrite");await e.objectStore("media").delete(t.id),await e.done,t.file&&URL.revokeObjectURL(t.file),o.alarms=o.alarms.filter(n=>n.id!==t.id),o.selected===t.id&&(o.selected=null)}catch(e){console.error("刪除失敗:",e),p.value="刪除失敗，請稍後再試。"}};return A(async()=>{await h(),await k()}),(t,e)=>(f(),D(N,null,{default:d(()=>[r($,null,{default:d(()=>[r(w,{cols:"12"},{default:d(()=>e[1]||(e[1]=[a("h1",{class:"text-center"},"鈴聲設定",-1)])),_:1,__:[1]}),r(w,{cols:"12"},{default:d(()=>[r(Y,null,{default:d(()=>[e[2]||(e[2]=a("thead",null,[a("tr",null,[a("th",null,"名稱"),a("th",null,"試聽"),a("th",null,"選擇"),a("th",null,"刪除")])],-1)),a("tbody",null,[(f(!0),y(K,null,O(b(o).alarms,l=>(f(),y("tr",{key:l.id},[a("td",null,v(l.name),1),a("td",null,[a("audio",{controls:"",src:l.file},null,8,Q)]),a("td",null,[r(E,{modelValue:b(o).selected,"onUpdate:modelValue":e[0]||(e[0]=n=>b(o).selected=n),"hide-details":""},{default:d(()=>[r(G,{value:l.id},null,8,["value"])]),_:2},1032,["modelValue"])]),a("td",null,[S(l)?(f(),y("button",{key:0,title:"刪除",onClick:n=>F(l)},[r(T,{icon:"mdi-delete",onClick:t.addAlarms},null,8,["onClick"])],8,W)):V("",!0)])]))),128))])]),_:1,__:[2]})]),_:1}),r(w,{cols:"12"},{default:d(()=>[a("label",X,[e[3]||(e[3]=I(" ＋ ")),a("input",{accept:".mp3, .mp4",hidden:"",multiple:"",type:"file",onChange:x},null,32)]),p.value?(f(),y("p",Z,v(p.value),1)):V("",!0),e[4]||(e[4]=a("img",{src:M,style:{width:"300px"}},null,-1))]),_:1,__:[4]})]),_:1})]),_:1}))}},ae=j(q,[["__scopeId","data-v-cfdaf705"]]);export{ae as default};
